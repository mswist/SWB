<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Decision Tree</title>
</head>
<body>
    <form name="decision" onsubmit="document.forms[0].reportValidity(); return false">
    </form>
    <template id="question">
        <p>
            <label for=""></label>
        </p>
    </template>
    <template id="decline">
        <p class="decline"></p>
    </template>
</body>
<script src="questions.js"></script>
<script>
    const form = document.forms["decision"]
    const q_template = document.querySelector("#question")
    const d_template = document.querySelector("#decline")

    let initial_question = Object.keys(questions).find(q => questions[q].initial)
    showQuestion(initial_question)

    form.addEventListener("change", (e) => {
        let next_action = flow[e.target?.dataset?.question]?.next
        if(next_action) {
            let current_p = e.target.closest('p')
            while(current_p?.nextElementSibling?.nodeName == 'P') {
                current_p.nextElementSibling.remove()
            }
            next_action.forEach(next => {
                if(e.target.value == next.condition || next.condition.includes(e.target.value)) {
                    next.questions.forEach( q => showQuestion(q))
                }
            }) 
        }
        let decline_action = flow[e.target?.dataset?.question]?.decline
        if(decline_action) {
            let current_p = e.target.closest('p')
            while(current_p?.nextElementSibling?.nodeName == 'P') {
                current_p.nextElementSibling.remove()
            }            
            decline_action.forEach(decline => {
                if(e.target.value == decline.condition || decline.condition.includes(e.target.value)) {
                    let p_decline = d_template.content.cloneNode(true);
                    p_decline.firstElementChild.textContent = decline.message;
                    form.appendChild(p_decline)                    
                }
            }) 
        }        
    })

    function showQuestion(question) {
        let question_data = questions[question]
        let line = q_template.content.cloneNode(true);
        line.querySelector("label").innerHTML = question_data.label;
        let element = buildElement(question_data, question)
        element.dataset.question = question
        line.querySelector("p").appendChild(element)
        form.appendChild(line)        
    }
    
    function buildElement(data, name) {
        let element;
        if(Array.isArray(data.type)) {
            element = buildSelect(data.type)
        }
        else if(data.type === Boolean) {
            element = document.createElement("span")
            element.insertAdjacentHTML("beforeend",`<input data-question=${name} name=${name} value="Yes" type="radio">Yes</input`)
            element.insertAdjacentHTML("beforeend",`<input data-question=${name} name=${name} value="No" type="radio">No</input`)
        }
        else if(data.type === "number") {
            element = document.createElement("input")
            element.type = "number"
            if(data.max) element.max = data.max            
        }
        return element
    }

    function buildSelect(type) {
        let select = document.createElement("select")
        type.forEach(answer => {
            let option = document.createElement("option")
            option.textContent = answer;
            select.appendChild(option)
        })
        return select
    }

</script>
</html>